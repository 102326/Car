<script setup lang="ts">
import { ref } from 'vue'
import type { Ref } from 'vue'

/**
 * ç”¨æˆ·ä¿¡æ¯æ¥å£
 */
interface UserInfo {
  nickname: string
  avatar: string
  level: number
  badge: string
  followers: number
  following: number
  coins: number
}

/**
 * ç”¨æˆ·ä¿¡æ¯
 */
const userInfo: Ref<UserInfo> = ref<UserInfo>({
  nickname: 'å¼€å¼€å¿ƒå¿ƒæŸšå­8402',
  avatar: 'https://via.placeholder.com/80x80/FF6B9D/FFFFFF?text=U',
  level: 1,
  badge: 'è·å–å‹‹ç« ',
  followers: 0,
  following: 0,
  coins: 0
})

/**
 * æ˜¯å¦æ˜¾ç¤ºç­¾åˆ°æç¤º
 */
const showSignInTip: Ref<boolean> = ref<boolean>(true)

/**
 * åŠŸèƒ½èœå•æ¥å£
 */
interface MenuItem {
  id: number
  icon: string
  name: string
  path?: string
}

/**
 * ä¸»è¦åŠŸèƒ½èœå•
 */
const mainMenus: MenuItem[] = [
  { id: 1, icon: 'âœï¸', name: 'åˆ›ä½œä¸­å¿ƒ', path: '/create' },
  { id: 2, icon: 'â­', name: 'æ”¶è—', path: '/favorite' },
  { id: 3, icon: 'â°', name: 'è¶³è¿¹', path: '/history' },
  { id: 4, icon: 'ğŸ“', name: 'è®¢å•', path: '/orders' },
  { id: 5, icon: 'ğŸ’¬', name: 'æ¶ˆæ¯', path: '/messages' }
]

/**
 * çˆ±è½¦æœåŠ¡èœå•
 */
const carServiceMenus: MenuItem[] = [
  { id: 1, icon: 'â›½', name: 'ä¼˜æƒ åŠ æ²¹' },
  { id: 2, icon: 'ğŸš—', name: 'ç§Ÿè½¦' },
  { id: 3, icon: 'ğŸ“Š', name: 'çˆ±è½¦ä¼°å€¼' },
  { id: 4, icon: 'ğŸ’°', name: 'æˆ‘è¦å–è½¦' },
  { id: 5, icon: 'ğŸ›ï¸', name: 'æ˜“è½¦å•†åŸ' },
  { id: 6, icon: 'ğŸ¨', name: 'è½¦è¡£ç¦åˆ©' },
  { id: 7, icon: 'ğŸ“±', name: 'æ›´å¤š' }
]

/**
 * å…¶ä»–æœåŠ¡èœå•
 */
const otherServiceMenus: MenuItem[] = [
  { id: 1, icon: 'ğŸ', name: 'è½¦å¸ç¦åˆ©' },
  { id: 2, icon: 'Â¥', name: 'æˆ‘çš„è½¦å¸' },
  { id: 3, icon: 'ğŸ«', name: 'æˆ‘çš„å¡åˆ¸' },
  { id: 4, icon: 'ğŸ“‹', name: 'ç‚¹è¯„æœ‰ç¤¼' },
  { id: 5, icon: 'ğŸ“¢', name: 'ç”¨æˆ·åé¦ˆ' }
]

/**
 * NPSè¯„åˆ†å¼¹çª—æ˜¾ç¤ºçŠ¶æ€
 */
const showNPSDialog: Ref<boolean> = ref<boolean>(true)

/**
 * NPSè¯„åˆ†å€¼
 */
const npsScore: Ref<number> = ref<number>(-1)

/**
 * å¤„ç†æ‰«ç 
 */
const handleScan = (): void => {
  console.log('æ‰«ç ')
}

/**
 * å¤„ç†å®‰å…¨ä¸­å¿ƒ
 */
const handleSecurity = (): void => {
  console.log('å®‰å…¨ä¸­å¿ƒ')
}

/**
 * å¤„ç†ç¼–è¾‘èµ„æ–™
 */
const handleEdit = (): void => {
  console.log('ç¼–è¾‘èµ„æ–™')
}

/**
 * å¤„ç†ç­¾åˆ°
 */
const handleSignIn = (): void => {
  console.log('ç­¾åˆ°')
  showSignInTip.value = false
}

/**
 * å¤„ç†ä¸»èœå•ç‚¹å‡»
 */
const handleMainMenuClick = (item: MenuItem): void => {
  console.log('ç‚¹å‡»ä¸»èœå•:', item.name)
}

/**
 * å¤„ç†çˆ±è½¦æœåŠ¡èœå•ç‚¹å‡»
 */
const handleCarServiceClick = (item: MenuItem): void => {
  console.log('ç‚¹å‡»çˆ±è½¦æœåŠ¡:', item.name)
}

/**
 * å¤„ç†å…¶ä»–æœåŠ¡èœå•ç‚¹å‡»
 */
const handleOtherServiceClick = (item: MenuItem): void => {
  console.log('ç‚¹å‡»å…¶ä»–æœåŠ¡:', item.name)
}

/**
 * å¤„ç†æ·»åŠ çˆ±è½¦
 */
const handleAddCar = (): void => {
  console.log('æ·»åŠ çˆ±è½¦')
}

/**
 * å¤„ç†NPSè¯„åˆ†é€‰æ‹©
 */
const handleNPSSelect = (score: number): void => {
  npsScore.value = score
}

/**
 * æäº¤NPSè¯„åˆ†
 */
const handleNPSSubmit = (): void => {
  if (npsScore.value >= 0) {
    console.log('NPSè¯„åˆ†:', npsScore.value)
    showNPSDialog.value = false
  }
}

/**
 * å…³é—­NPSå¼¹çª—
 */
const handleNPSClose = (): void => {
  showNPSDialog.value = false
}
</script>

<template>
  <div class="mine-page">
    <!-- é¡¶éƒ¨æ“ä½œæ  -->
    <div class="top-actions">
      <van-icon name="scan" class="action-icon" @click="handleScan" />
      <van-icon name="shield-o" class="action-icon" @click="handleSecurity" />
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <div class="user-card">
      <div class="user-header">
        <div class="user-avatar">
          <img :src="userInfo.avatar" :alt="userInfo.nickname" />
        </div>
        <div class="user-info">
          <div class="user-name">
            {{ userInfo.nickname }}
            <van-icon name="edit" class="edit-icon" @click="handleEdit" />
          </div>
          <div class="user-badges">
            <div class="level-badge">Lv{{ userInfo.level }}</div>
            <div class="get-badge">{{ userInfo.badge }}</div>
            <div v-if="showSignInTip" class="sign-in-tip" @click="handleSignIn">
              <span>ç­¾åˆ°+1</span>
            </div>
          </div>
        </div>
      </div>

      <div class="user-stats">
        <div class="stat-item">
          <div class="stat-label">å…³æ³¨</div>
          <div class="stat-value">{{ userInfo.following }}</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <div class="stat-label">ç²‰ä¸</div>
          <div class="stat-value">{{ userInfo.followers }}</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
          <div class="stat-label">æ˜“è½¦å¸</div>
          <div class="stat-value">{{ userInfo.coins }}</div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½èœå• -->
    <div class="main-menus">
      <div 
        v-for="item in mainMenus" 
        :key="item.id"
        class="menu-item"
        @click="handleMainMenuClick(item)"
      >
        <div class="menu-icon">{{ item.icon }}</div>
        <div class="menu-name">{{ item.name }}</div>
      </div>
    </div>

    <!-- çˆ±è½¦æœåŠ¡ -->
    <div class="service-section">
      <div class="section-header">
        <div class="section-title">çˆ±è½¦æœåŠ¡</div>
        <div class="section-action" @click="handleAddCar">
          <span>æ·»åŠ çˆ±è½¦</span>
          <van-icon name="arrow" />
        </div>
      </div>

      <div class="service-grid">
        <div 
          v-for="item in carServiceMenus" 
          :key="item.id"
          class="service-item"
          @click="handleCarServiceClick(item)"
        >
          <div class="service-icon">{{ item.icon }}</div>
          <div class="service-name">{{ item.name }}</div>
        </div>
      </div>
    </div>

    <!-- å…¶ä»–æœåŠ¡ -->
    <div class="other-service-section">
      <div class="other-service-grid">
        <div 
          v-for="item in otherServiceMenus" 
          :key="item.id"
          class="other-service-item"
          @click="handleOtherServiceClick(item)"
        >
          <div class="service-icon">{{ item.icon }}</div>
          <div class="service-name">{{ item.name }}</div>
        </div>
      </div>
    </div>

    <!-- NPSè¯„åˆ†å¼¹çª— -->
    <van-popup 
      v-model:show="showNPSDialog" 
      round
      closeable
      position="bottom"
      :style="{ padding: '20px' }"
      @click-close-icon="handleNPSClose"
    >
      <div class="nps-dialog">
        <div class="nps-question">æ˜¯å¦æ„¿æ„å‘æœ‹å‹æ¨èæ˜“è½¦App?</div>
        
        <div class="nps-scale">
          <div class="scale-label">
            <span>ä¸å¯èƒ½</span>
            <span>ææœ‰å¯èƒ½</span>
          </div>
          <div class="scale-numbers">
            <div 
              v-for="score in 11" 
              :key="score - 1"
              :class="['scale-number', { active: npsScore === score - 1 }]"
              @click="handleNPSSelect(score - 1)"
            >
              {{ score - 1 }}
            </div>
          </div>
        </div>

        <div class="nps-submit">
          <van-button 
            type="primary" 
            block 
            round
            :disabled="npsScore < 0"
            @click="handleNPSSubmit"
          >
            æäº¤
          </van-button>
        </div>
      </div>
    </van-popup>
  </div>
</template>

<style scoped>
.mine-page {
  width: 100%;
  min-height: 100vh;
  padding-bottom: 50px;
  background: linear-gradient(180deg, #f0f5ff 0%, #f7f8fa 30%);
}

/* é¡¶éƒ¨æ“ä½œæ  */
.top-actions {
  display: flex;
  justify-content: flex-end;
  gap: 20px;
  padding: 12px 16px;
}

.action-icon {
  font-size: 24px;
  color: #323233;
  cursor: pointer;
}

/* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
.user-card {
  margin: 0 16px 16px;
  padding: 20px;
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.user-header {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
}

.user-avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  overflow: hidden;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.user-info {
  flex: 1;
}

.user-name {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 500;
  color: #323233;
  margin-bottom: 8px;
}

.edit-icon {
  font-size: 16px;
  color: #969799;
  cursor: pointer;
}

.user-badges {
  display: flex;
  align-items: center;
  gap: 8px;
}

.level-badge {
  padding: 2px 8px;
  background-color: #e8e8e8;
  border-radius: 10px;
  font-size: 11px;
  color: #646566;
}

.get-badge {
  padding: 2px 8px;
  background-color: #fff3e6;
  border-radius: 10px;
  font-size: 11px;
  color: #ff9500;
}

.sign-in-tip {
  padding: 2px 8px;
  background: linear-gradient(135deg, #ffa500 0%, #ff6b00 100%);
  border-radius: 10px;
  font-size: 11px;
  color: #ffffff;
  cursor: pointer;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

.user-stats {
  display: flex;
  align-items: center;
  justify-content: space-around;
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.stat-label {
  font-size: 13px;
  color: #969799;
}

.stat-value {
  font-size: 16px;
  font-weight: 500;
  color: #323233;
}

.stat-divider {
  width: 1px;
  height: 20px;
  background-color: #ebedf0;
}

/* ä¸»è¦åŠŸèƒ½èœå• */
.main-menus {
  display: flex;
  justify-content: space-around;
  padding: 20px;
  margin: 0 16px 16px;
  background-color: #ffffff;
  border-radius: 12px;
}

.menu-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.menu-icon {
  font-size: 28px;
}

.menu-name {
  font-size: 12px;
  color: #646566;
}

/* çˆ±è½¦æœåŠ¡ */
.service-section {
  margin: 0 16px 16px;
  padding: 16px;
  background-color: #ffffff;
  border-radius: 12px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.section-title {
  font-size: 16px;
  font-weight: 500;
  color: #323233;
}

.section-action {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
  color: #969799;
  cursor: pointer;
}

.service-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
}

.service-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.service-icon {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
  border-radius: 12px;
}

.service-name {
  font-size: 12px;
  color: #646566;
  text-align: center;
}

/* å…¶ä»–æœåŠ¡ */
.other-service-section {
  margin: 0 16px 16px;
  padding: 16px;
  background-color: #ffffff;
  border-radius: 12px;
}

.other-service-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 20px;
}

.other-service-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

/* NPSè¯„åˆ†å¼¹çª— */
.nps-dialog {
  padding: 20px 0;
}

.nps-question {
  font-size: 16px;
  font-weight: 500;
  color: #323233;
  text-align: center;
  margin-bottom: 24px;
}

.nps-scale {
  margin-bottom: 24px;
}

.scale-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  font-size: 12px;
  color: #969799;
}

.scale-numbers {
  display: flex;
  justify-content: space-between;
  gap: 4px;
}

.scale-number {
  flex: 1;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f7f8fa;
  border-radius: 8px;
  font-size: 14px;
  color: #646566;
  cursor: pointer;
  transition: all 0.3s;
}

.scale-number:hover {
  background-color: #fff1f0;
}

.scale-number.active {
  background-color: #e52e2e;
  color: #ffffff;
  font-weight: bold;
  transform: scale(1.1);
}

.nps-submit :deep(.van-button) {
  background: linear-gradient(135deg, #ff6b6b 0%, #e52e2e 100%);
  border: none;
}

.nps-submit :deep(.van-button--disabled) {
  background: #ebedf0;
}
</style>
